# Bun Troubleshooting: CI/CD Publishing Issues (Part 1)

> **Navigation**: [Index](bun-troubleshooting.md) | [Part 2: Version & Registry](bun-troubleshooting-part2-version-registry.md)

This section covers issues related to CI/CD publishing workflows.

---

## Table of Contents

- [1. OIDC Authentication Error](#1-oidc-authentication-error)
  - [Problem Description](#problem-description)
  - [Root Cause](#root-cause)
  - [Solution](#solution)
  - [When This Issue Occurs](#when-this-issue-occurs)
- [2. Unpinned Version Issues](#2-unpinned-version-issues)
  - [Problem Description](#problem-description-1)
  - [Root Cause](#root-cause-1)
  - [Solution](#solution-1)
  - [Best Practices](#best-practices)
  - [When This Issue Occurs](#when-this-issue-occurs-1)

---

## 1. OIDC Authentication Error

### Problem Description

When attempting to publish a package to npm using the `bun publish` command in GitHub Actions, you encounter an authentication error:

```
error: missing authentication
```

This error occurs even when using provenance and OIDC (OpenID Connect) authentication tokens provided by GitHub Actions.

### Root Cause

As of the current version, Bun does not fully support OIDC token-based authentication for npm publishing. The `bun publish` command expects traditional npm authentication tokens but cannot properly handle the OIDC tokens generated by GitHub Actions workflows.

OIDC (OpenID Connect) is a modern authentication layer that allows GitHub Actions to authenticate to npm without storing long-lived tokens. However, Bun's publish functionality has not yet integrated this authentication method.

### Solution

Use the npm CLI instead of Bun for publishing packages:

**Step 1**: Replace `bun publish` with `npm publish` in your workflow file.

**Step 2**: Ensure your workflow has the proper OIDC permissions:

```yaml
permissions:
  contents: read
  id-token: write
```

**Step 3**: Configure the npm authentication in your workflow:

```yaml
- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    node-version: '20'
    registry-url: 'https://registry.npmjs.org'

- name: Publish to npm
  run: npm publish --provenance --access public
  env:
    NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

**Example Complete Workflow**:

```yaml
name: Publish Package
on:
  release:
    types: [published]

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.1.42'

      - name: Install dependencies
        run: bun install

      - name: Build package
        run: bun run build

      - name: Setup Node.js for publishing
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Publish to npm
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

### When This Issue Occurs

- Publishing packages from GitHub Actions workflows
- Using OIDC authentication instead of traditional npm tokens
- Attempting to use `bun publish` command in CI/CD pipelines

---

## 2. Unpinned Version Issues

### Problem Description

When using `bun-version: latest` in GitHub Actions workflows, builds become flaky and unpredictable. Different workflow runs may use different versions of Bun, leading to:

- Inconsistent build outputs
- Tests passing in one run and failing in another
- Breaking changes introduced silently
- Difficult-to-reproduce bugs

### Root Cause

The `latest` tag always points to the most recent release of Bun. Since Bun is under active development and frequently releases new versions, using `latest` means your workflow can break at any time when a new version is published. New versions may:

- Introduce breaking changes to APIs
- Change default behavior
- Fix bugs that your code was unknowingly relying on
- Update bundler behavior

### Solution

Pin the Bun version to a specific release to ensure consistent, reproducible builds.

**Step 1**: Choose a specific Bun version from the [official releases page](https://github.com/oven-sh/bun/releases).

**Step 2**: Update your workflow file to use the pinned version:

```yaml
- name: Setup Bun
  uses: oven-sh/setup-bun@v2
  with:
    bun-version: '1.1.42'
```

**Step 3**: When you want to upgrade Bun, test the new version first:

```yaml
# Create a test branch workflow
- name: Setup Bun
  uses: oven-sh/setup-bun@v2
  with:
    bun-version: '1.1.43'  # New version to test
```

**Step 4**: After verifying the new version works, update your main workflow.

### Best Practices

**Version Strategy**:
- Pin to exact versions: `1.1.42` (recommended)
- Avoid: `latest`, `1.x`, `1.1.x`

**Update Workflow**:
1. Monitor Bun release notes for new versions
2. Test new versions in a separate branch
3. Update the pinned version after successful testing
4. Document version changes in your changelog

**Example Pinned Configuration**:

```yaml
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        bun-version: ['1.1.42']  # Single pinned version

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ matrix.bun-version }}

      - name: Display Bun version
        run: bun --version

      - name: Install dependencies
        run: bun install
```

### When This Issue Occurs

- Using `bun-version: latest` in CI/CD workflows
- Builds that were working suddenly fail without code changes
- Different developers getting different build results
- Inconsistent behavior between local development and CI

---

> **Next**: [Part 2: Version & Registry Issues](bun-troubleshooting-part2-version-registry.md)
